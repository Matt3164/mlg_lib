---

title: How to train a COITE ensemble on FMNIST
keywords: fastai
sidebar: home_sidebar

summary: "See how"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/20_application.icote_on_fmnist.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="k">import</span> <span class="n">fetch_openml</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">train_test_split</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="s2">&quot;Fashion-MNIST&quot;</span><span class="p">,</span> <span class="n">data_home</span><span class="o">=</span><span class="s2">&quot;/home/matthieu/sklearn_data&quot;</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>

<span class="n">xtrain</span><span class="p">,</span> <span class="n">xtest</span><span class="p">,</span> <span class="n">ytrain</span><span class="p">,</span> <span class="n">ytest</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mlg_lib.imgfeat</span> <span class="k">import</span> <span class="n">HogFactory</span><span class="p">,</span> <span class="n">DaisyFactory</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">LBPFactory</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">HogFactory</span><span class="p">(</span><span class="n">orientations</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">pixels_per_cell</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span><span class="n">cells_per_block</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">multichannel</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">DaisyFactory</span><span class="p">(</span><span class="n">orientations</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rings</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">flatten</span><span class="p">,</span>
    <span class="n">LBPFactory</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">FEATURE_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;HOG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DAISY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RAW&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LBP&quot;</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mlg_lib.ml_utils</span> <span class="k">import</span> <span class="n">make_single_feature_model</span><span class="p">,</span> <span class="n">sk_train</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">ExtraTreesClassifier</span><span class="p">,</span> <span class="n">VotingClassifier</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">VotingClassifier</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="n">FEATURE_NAMES</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">(</span> 
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">make_single_feature_model</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ExtraTreesClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">25</span><span class="p">)),</span> <span class="n">FEATURES</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="n">voting</span><span class="o">=</span><span class="s2">&quot;soft&quot;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="n">sk_train</span><span class="p">(</span><span class="n">xtrain</span><span class="p">,</span> <span class="n">xtest</span><span class="p">,</span> <span class="n">ytrain</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">cm</span><span class="o">=</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">accuracy_score</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>TrainingOutput(model=VotingClassifier(estimators=[(&#39;HOG&#39;,
                              Pipeline(memory=None,
                                       steps=[(&#39;lambdarow&#39;,
                                               LambdaRow(row_func=HogFactory(orientations=8, pixels_per_cell=(8, 8), cells_per_block=(1, 1), multichannel=False))),
                                              (&#39;extratreesclassifier&#39;,
                                               ExtraTreesClassifier(bootstrap=False,
                                                                    class_weight=None,
                                                                    criterion=&#39;gini&#39;,
                                                                    max_depth=None,
                                                                    max_features=&#39;auto&#39;,
                                                                    max_leaf_nodes=None,
                                                                    min_impurit...
                                                                    criterion=&#39;gini&#39;,
                                                                    max_depth=None,
                                                                    max_features=&#39;auto&#39;,
                                                                    max_leaf_nodes=None,
                                                                    min_impurity_decrease=0.0,
                                                                    min_impurity_split=None,
                                                                    min_samples_leaf=1,
                                                                    min_samples_split=2,
                                                                    min_weight_fraction_leaf=0.0,
                                                                    n_estimators=25,
                                                                    n_jobs=None,
                                                                    oob_score=False,
                                                                    random_state=None,
                                                                    verbose=0,
                                                                    warm_start=False))],
                                       verbose=False))],
                 flatten_transform=True, n_jobs=None, voting=&#39;soft&#39;,
                 weights=None), metrics={&#39;train_cm&#39;: array([[6019,    0,    0,    0,    0,    0,    0,    0,    0,    0],
       [   0, 5964,    0,    0,    0,    0,    0,    0,    0,    0],
       [   0,    0, 5955,    0,    0,    0,    0,    0,    0,    0],
       [   0,    0,    0, 5988,    0,    0,    0,    0,    0,    0],
       [   0,    0,    0,    0, 6028,    0,    0,    0,    0,    0],
       [   0,    0,    0,    0,    0, 6007,    0,    0,    0,    0],
       [   0,    0,    0,    0,    0,    0, 6009,    0,    0,    0],
       [   0,    0,    0,    0,    0,    0,    0, 6003,    0,    0],
       [   0,    0,    0,    0,    0,    0,    0,    0, 6004,    0],
       [   0,    0,    0,    0,    0,    0,    0,    0,    0, 6023]]), &#39;train_acc&#39;: 1.0, &#39;test_cm&#39;: array([[848,   0,  10,  41,   6,   0,  61,   0,  15,   0],
       [  0, 995,   5,  30,   1,   0,   4,   0,   1,   0],
       [  5,   0, 872,  10,  95,   0,  57,   0,   6,   0],
       [ 19,   4,   8, 926,  27,   0,  27,   0,   1,   0],
       [  0,   1,  44,  43, 833,   0,  45,   0,   6,   0],
       [  0,   0,   0,   0,   0, 945,   0,  32,   3,  13],
       [180,   0,  96,  37,  84,   0, 576,   0,  18,   0],
       [  0,   0,   0,   0,   0,  21,   0, 936,   2,  38],
       [  5,   0,   4,   4,   3,   1,   5,   1, 971,   2],
       [  0,   0,   0,   0,   0,   3,   0,  34,   0, 940]]), &#39;test_acc&#39;: 0.8842})</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="k">import</span> <span class="n">RandomForestClassifier</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">VotingClassifier</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="n">FEATURE_NAMES</span><span class="p">,</span>
        <span class="nb">list</span><span class="p">(</span> 
            <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">make_single_feature_model</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="s2">&quot;log2&quot;</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">)),</span> <span class="n">FEATURES</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="n">voting</span><span class="o">=</span><span class="s2">&quot;soft&quot;</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="n">sk_train</span><span class="p">(</span><span class="n">xtrain</span><span class="p">,</span> <span class="n">xtest</span><span class="p">,</span> <span class="n">ytrain</span><span class="p">,</span> <span class="n">ytest</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">cm</span><span class="o">=</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="n">accuracy_score</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

